<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DragoDiet</title>

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.boxicons.com/3.0.5/fonts/basic/boxicons.min.css"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="wrapper wide">
      <h1>Lvl <span id="lvl">{{ stats.level }}</span> Dragon</h1>

      <div class="stats-row">
        <span><i class="bx bx-heart"></i> Health</span>
        <span><span id="hp">{{ stats.health }}</span>%</span>
      </div>
      <div class="bar-container">
        <div
          id="health-bar"
          class="hp-bar"
          style="width: {{ stats.health }}%;"
        ></div>
      </div>

      <div class="stats-row">
        <span><i class="bx bx-star"></i> XP</span>
        <span id="xp-text">{{ stats.xp % 100 }} / 100</span>
      </div>
      <div class="bar-container">
        <div
          id="xp-bar"
          class="xp-bar"
          style="width: {{ stats.xp % 100 }}%;"
        ></div>
      </div>

      <div class="dragon-container">
        <img
          id="dragon"
          src="/static/dragon_neutral.png"
          onerror="this.src='https://cdn-icons-png.flaticon.com/512/371/371669.png'"
        />
      </div>

      <p id="msg">I am hungry!</p>

      <label class="btn">
        <i class="bx bx-camera"></i> Feed Me
        <input type="file" id="cam" accept="image/*" capture="environment" />
      </label>
    </div>

    <script>
      const cam = document.getElementById("cam");
      const msg = document.getElementById("msg");
      const dragon = document.getElementById("dragon");
      const healthBar = document.getElementById("health-bar");
      const xpBar = document.getElementById("xp-bar");

      cam.addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        msg.innerText = "Analyzing... ðŸ¥—ðŸ”";
        msg.style.color = "#333"; // Changed to match your theme

        const formData = new FormData();
        formData.append("image", file);

        try {
          const res = await fetch("/feed", { method: "POST", body: formData });
          const data = await res.json();

          if (data.error) {
            msg.innerText = "âš ï¸ " + data.error;
            msg.style.color = "red";
            return;
          }

          let hpSign = data.hp_change >= 0 ? "+" : "";
          let xpSign = "+" + data.xp_change;
          msg.innerHTML = `Ate <b>${data.food}</b>!<br> ${hpSign}${data.hp_change} HP | ${xpSign} XP`;

          document.getElementById("hp").innerText = data.stats.health;
          document.getElementById("lvl").innerText = data.stats.level;
          document.getElementById("xp-text").innerText =
            (data.stats.xp % 100) + " / 100";

          healthBar.style.width = data.stats.health + "%";
          xpBar.style.width = (data.stats.xp % 100) + "%";

          if (data.stats.health < 30) healthBar.style.background = "#ff4444";
          else healthBar.style.background = "#4caf50";

          if (data.mood === "happy") {
            dragon.src = "/static/dragon_happy.png";
            dragon.classList.add("happy-anim");
          } else if (data.mood === "sick") {
            dragon.src = "/static/dragon_sick.png";
            dragon.classList.add("sick-anim");
          }

          setTimeout(() => {
            dragon.src = "/static/dragon_neutral.png";
            dragon.classList.remove("happy-anim", "sick-anim");
          }, 3000);
        } catch (err) {
          msg.innerText = "Error connecting to server";
          console.error(err);
        }
      });
    </script>
  </body>
</html>
